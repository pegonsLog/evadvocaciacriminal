<ng-container *ngIf="currentUser$ | async as user; else loginView">
  <header class="modern-header">
    <nav class="navbar">
      <div class="container-fluid">
        <!-- Brand Section -->
        <div class="brand-section">
          <a class="brand-link" routerLink="/home">
            <div class="brand-icon">
              <img src="assets/icons/LogoEvac128.png" alt="EV Advocacia Criminal" class="brand-logo">
            </div>
            <div class="brand-content">
              <h1 class="brand-title">{{ title }}</h1>
              <span class="brand-subtitle">Sistema de Gestão de Contratos</span>
            </div>
          </a>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-toggle" type="button" (click)="toggleMobileMenu()" [class.active]="isMobileMenuOpen">
          <span class="toggle-line"></span>
          <span class="toggle-line"></span>
          <span class="toggle-line"></span>
        </button>

        <!-- Navigation Menu -->
        <div class="nav-menu" [class.mobile-open]="isMobileMenuOpen">
          <ul class="nav-list">
            <li class="nav-item">
              <a class="nav-link" routerLink="/home" routerLinkActive="active" (click)="closeMobileMenu()">
                <div class="nav-icon">
                  <i class="bi bi-house-door"></i>
                </div>
                <span class="nav-text">Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" routerLink="/clientes" routerLinkActive="active" (click)="closeMobileMenu()">
                <div class="nav-icon">
                  <i class="bi bi-people"></i>
                </div>
                <span class="nav-text">Clientes</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" routerLink="/controle-pagamentos" routerLinkActive="active"
                (click)="closeMobileMenu()">
                <div class="nav-icon">
                  <i class="bi bi-graph-up-arrow"></i>
                </div>
                <span class="nav-text">Pagamentos</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" routerLink="/relatorio-consulta-geral" routerLinkActive="active"
                (click)="closeMobileMenu()">
                <div class="nav-icon">
                  <i class="bi bi-bar-chart-line"></i>
                </div>
                <span class="nav-text">Relatórios</span>
              </a>
            </li>
            <li class="nav-item" *ngIf="user.role === UserRole.ADMIN">
              <a class="nav-link" routerLink="/usuarios" routerLinkActive="active" (click)="closeMobileMenu()">
                <div class="nav-icon">
                  <i class="bi bi-person-gear"></i>
                </div>
                <span class="nav-text">Usuários</span>
              </a>
            </li>
          </ul>

          <!-- User Section -->
          <div class="user-section">
            <div class="user-info">
              <div class="user-avatar">
                <i class="bi bi-person-circle"></i>
              </div>
              <div class="user-details">
                <span class="user-name">{{ user.displayName }}</span>
                <span class="user-role">{{ getUserRoleText(user.role) }}</span>
              </div>
            </div>

            <div class="user-actions">
              <button class="action-btn logout-btn" (click)="logout()" title="Sair">
                <i class="bi bi-box-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Backdrop for mobile menu -->
        <div class="mobile-backdrop" [class.active]="isMobileMenuOpen" (click)="closeMobileMenu()"></div>
      </div>
    </nav>
  </header>

  <!-- PWA Update Notification -->
  <div class="pwa-update-notification" *ngIf="showUpdateNotification">
    <div class="update-content">
      <div class="update-icon">
        <i class="bi bi-arrow-clockwise"></i>
      </div>
      <div class="update-message">
        <h6>Nova versão disponível!</h6>
        <p>Uma atualização da aplicação está disponível.</p>
      </div>
      <div class="update-actions">
        <button class="btn btn-sm btn-primary" (click)="applyPWAUpdate()">
          Atualizar
        </button>
        <button class="btn btn-sm btn-outline-secondary" (click)="dismissUpdateNotification()">
          Mais tarde
        </button>
      </div>
    </div>
  </div>

  <!-- PWA Error Status (opcional - apenas para debugging) -->
  <!-- <app-pwa-error-status></app-pwa-error-status> -->



  <main class="main-content">
    <router-outlet></router-outlet>
  </main>

  <footer class="modern-footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-copyright">
          <p>&copy; 2025 EV Advocacia Criminal. Todos os direitos reservados.</p>
        </div>
      </div>
    </div>
  </footer>
</ng-container>

<ng-template #loginView>
  <router-outlet></router-outlet>
</ng-template>

<!-- Modal Global -->
<app-modal></app-modal>

<!-- Log Control (apenas em desenvolvimento) -->
<app-log-control></app-log-control>
